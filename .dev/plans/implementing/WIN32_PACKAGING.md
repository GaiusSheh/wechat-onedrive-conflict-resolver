# Win32ç¨‹åºæ‰“åŒ…åˆ†å‘ç­–ç•¥

## ğŸ“¦ æ‰“åŒ…åˆ†å‘ç°çŠ¶åˆ†æ

### å½“å‰åˆ†å‘æ–¹å¼çš„é—®é¢˜
| é—®é¢˜ç±»åˆ« | å…·ä½“è¡¨ç° | ç”¨æˆ·å½±å“ | è§£å†³ä¼˜å…ˆçº§ |
|----------|----------|----------|------------|
| **ç¯å¢ƒä¾èµ–** | éœ€è¦Python 3.6+ç¯å¢ƒ | æ™®é€šç”¨æˆ·æ— æ³•ä½¿ç”¨ | ğŸ”´ æé«˜ |
| **ä¾èµ–ç®¡ç†** | æ‰‹åŠ¨å®‰è£…å¤šä¸ªpipåŒ… | å®‰è£…è¿‡ç¨‹å¤æ‚æ˜“é”™ | ğŸ”´ æé«˜ |
| **åˆ†å‘å¤æ‚** | éœ€è¦Gitå…‹éš†æˆ–ä¸‹è½½æºç  | æŠ€æœ¯é—¨æ§›é«˜ | ğŸ”´ é«˜ |
| **æ›´æ–°å›°éš¾** | æ‰‹åŠ¨ä¸‹è½½æ–°ç‰ˆæœ¬ | ç”¨æˆ·æ›´æ–°ç‡ä½ | ğŸŸ¡ ä¸­ |
| **ä¸“ä¸šåº¦ä½** | ç¼ºä¹æ­£å¼å®‰è£…ç¨‹åº | å½±å“è½¯ä»¶å¯ä¿¡åº¦ | ğŸŸ¡ ä¸­ |
| **å›¾æ ‡ç¼ºå¤±** | ä»»åŠ¡æ æ˜¾ç¤ºPythoné»˜è®¤å›¾æ ‡ | ç”¨æˆ·è¯†åˆ«å›°éš¾ | ğŸŸ¡ ä¸­ |

### ğŸ¯ ç›®æ ‡ç”¨æˆ·åˆ†æ

#### ä¸»è¦ç”¨æˆ·ç¾¤ä½“
```python
# ç”¨æˆ·ç”»åƒåˆ†æ
primary_users = {
    "åŠå…¬ç”¨æˆ·": {
        "æŠ€æœ¯æ°´å¹³": "åˆçº§-ä¸­çº§",
        "æœŸæœ›": "åŒå‡»å³ç”¨ï¼Œæ— éœ€Pythonç¯å¢ƒ",
        "å æ¯”": "70%"
    },
    "æŠ€æœ¯ç”¨æˆ·": {
        "æŠ€æœ¯æ°´å¹³": "ä¸­çº§-é«˜çº§", 
        "æœŸæœ›": "ç‹¬ç«‹å¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ— ä¾èµ–",
        "å æ¯”": "25%"
    },
    "ä¼ä¸šç”¨æˆ·": {
        "æŠ€æœ¯æ°´å¹³": "ä¸­çº§",
        "æœŸæœ›": "ç»¿è‰²åŒ…éƒ¨ç½²ï¼Œæ— å¤–éƒ¨ä¾èµ–",
        "å æ¯”": "5%"
    }
}
```

#### è™šæ‹Ÿç¯å¢ƒæ‰“åŒ…ä¼˜åŠ¿ï¼ˆå¼ºåˆ¶è¦æ±‚ï¼‰
```python
# è™šæ‹Ÿç¯å¢ƒvsç³»ç»Ÿç¯å¢ƒæ‰“åŒ…å¯¹æ¯”
virtual_env_benefits = {
    "ä¾èµ–çº¯å‡€æ€§": "ä»…åŒ…å«é¡¹ç›®æ‰€éœ€çš„åŒ…ï¼Œé¿å…ç³»ç»Ÿç¯å¢ƒæ±¡æŸ“",
    "æ–‡ä»¶å¤§å°": "æ˜¾è‘—å‡å°‘exeæ–‡ä»¶å¤§å°ï¼Œä»200MB+é™ä½åˆ°50MBä»¥å†…",
    "ç‰ˆæœ¬ä¸€è‡´æ€§": "ç¡®ä¿æ‰€æœ‰ç”¨æˆ·ä½¿ç”¨ç›¸åŒçš„ä¾èµ–ç‰ˆæœ¬",
    "å†²çªé¿å…": "é˜²æ­¢ç³»ç»Ÿä¸­çš„å…¶ä»–PythonåŒ…å¹²æ‰°",
    "å¯é‡ç°æ€§": "ä»»ä½•äººéƒ½å¯ä»¥é‡ç°ç›¸åŒçš„æ‰“åŒ…ç»“æœ",
    "è´¨é‡ä¿è¯": "clean environmentç¡®ä¿æ‰“åŒ…è´¨é‡å’Œå…¼å®¹æ€§"
}

# å…³é”®éœ€æ±‚ä¼˜å…ˆçº§
requirements_priority = {
    "è™šæ‹Ÿç¯å¢ƒæ‰“åŒ…": "ğŸ”´ æé«˜ - å¼ºåˆ¶è¦æ±‚ï¼Œä¸å¯å¦¥å",
    "é›¶ä¾èµ–å®‰è£…": "ğŸ”´ æé«˜ - æ‰€æœ‰ç”¨æˆ·ç¾¤ä½“",
    "å•æ–‡ä»¶exe": "ğŸ”´ é«˜ - ä¾¿äºåˆ†å‘å’Œä½¿ç”¨",
    "ä¸“ä¸šå›¾æ ‡": "ğŸ”´ é«˜ - ä»»åŠ¡æ æ˜¾ç¤ºåº”ç”¨å›¾æ ‡è€ŒéPythonå›¾æ ‡",
    "æ–‡ä»¶å¤§å°æ§åˆ¶": "ğŸŸ¡ ä¸­ - <50MBç›®æ ‡ï¼ˆè™šæ‹Ÿç¯å¢ƒä¼˜åŒ–ï¼‰",
    "å®‰è£…ç¨‹åº": "ğŸŸ  ä½ - å¯é€‰å¢å¼ºåŠŸèƒ½"
}

# è™šæ‹Ÿç¯å¢ƒå¼ºåˆ¶ç­–ç•¥
venv_enforcement = {
    "æ„å»ºæ£€æŸ¥": "buildè„šæœ¬å¿…é¡»éªŒè¯è™šæ‹Ÿç¯å¢ƒçŠ¶æ€",
    "CI/CDè¦æ±‚": "æ‰€æœ‰è‡ªåŠ¨åŒ–æ„å»ºå¿…é¡»ä½¿ç”¨æ–°å»ºçš„è™šæ‹Ÿç¯å¢ƒ",
    "æœ¬åœ°å¼€å‘": "å¼€å‘è€…æœ¬åœ°æ‰“åŒ…å¿…é¡»å…ˆåˆ›å»ºclean venv",
    "è´¨é‡é—¨ç¦": "éè™šæ‹Ÿç¯å¢ƒæ‰“åŒ…çš„exeæ–‡ä»¶ä¸å¾—å‘å¸ƒ"
}
```

## ğŸ› ï¸ æŠ€æœ¯æ–¹æ¡ˆé€‰å‹

### æ‰“åŒ…å·¥å…·å¯¹æ¯”åˆ†æ

| å·¥å…· | æ–‡ä»¶å¤§å° | å¯åŠ¨é€Ÿåº¦ | å…¼å®¹æ€§ | æ˜“ç”¨æ€§ | å›¾æ ‡æ”¯æŒ | æ¨èåº¦ |
|------|----------|----------|--------|--------|----------|--------|
| **PyInstaller** | â­â­â­ | â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | ğŸ¥‡ **æ¨è** |
| cx_Freeze | â­â­â­â­ | â­â­â­ | â­â­â­â­ | â­â­â­ | â­â­â­â­ | ğŸ¥ˆ å¤‡é€‰ |
| Nuitka | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­ | â­â­ | â­â­â­ | ğŸ¥‰ é«˜æ€§èƒ½å¤‡é€‰ |
| py2exe | â­â­â­ | â­â­â­ | â­â­ | â­â­ | â­â­ | âŒ ä¸æ¨è |

### ğŸ¯ PyInstalleré€‰æ‹©ç†ç”±

#### æŠ€æœ¯ä¼˜åŠ¿
```python
# PyInstalleræ ¸å¿ƒä¼˜åŠ¿
1. æˆç†Ÿç¨³å®š
   - 10å¹´+å¼€å‘å†å²
   - å¤§é‡é¡¹ç›®å®è·µéªŒè¯
   - æ´»è·ƒçš„ç¤¾åŒºæ”¯æŒ

2. å…¼å®¹æ€§å¼º
   - æ”¯æŒPython 3.6-3.11
   - æ”¯æŒæ‰€æœ‰ä¸»æµç¬¬ä¸‰æ–¹åº“
   - Windows 7/10/11å…¼å®¹

3. åŠŸèƒ½å…¨é¢
   - å•æ–‡ä»¶æ‰“åŒ… (--onefile)
   - å›¾æ ‡å’Œç‰ˆæœ¬ä¿¡æ¯åµŒå…¥
   - ä¾èµ–è‡ªåŠ¨åˆ†æ
   - UPXå‹ç¼©æ”¯æŒ

4. å›¾æ ‡ç³»ç»Ÿå®Œæ•´
   - å¤šåˆ†è¾¨ç‡ICOæ–‡ä»¶æ”¯æŒ
   - ç‰ˆæœ¬ä¿¡æ¯åµŒå…¥
   - ä»»åŠ¡æ å›¾æ ‡æ­£ç¡®æ˜¾ç¤º
   - Windowsèµ„æºç®¡ç†å™¨å›¾æ ‡æ˜¾ç¤º

5. é…ç½®çµæ´»
   - specæ–‡ä»¶ç²¾ç¡®æ§åˆ¶
   - éšè—å¯¼å…¥å¤„ç†
   - æ•°æ®æ–‡ä»¶åŒ…å«
   - è¿è¡Œæ—¶hookç³»ç»Ÿ
```

#### v4.0ç‰ˆæœ¬æ‰“åŒ…ç›®æ ‡ï¼ˆæ›´æ–°ç‰ˆï¼‰
```python
# v4.0è™šæ‹Ÿç¯å¢ƒæ‰“åŒ…ä¼˜åŒ–ç›®æ ‡
v4_packaging_targets = {
    "ç‰ˆæœ¬å·": "v4.0 - ä¸“ä¸šæ‰“åŒ…å‘å¸ƒç‰ˆ",
    "å›¾æ ‡ç³»ç»Ÿ": "å®Œæ•´çš„å¤šåˆ†è¾¨ç‡ICOï¼Œä»»åŠ¡æ æ­£ç¡®æ˜¾ç¤ºè‡ªå®šä¹‰å›¾æ ‡",
    "æ–‡ä»¶å¤§å°": "<30MB (å¹²å‡€è™šæ‹Ÿç¯å¢ƒæœ€ä¼˜åŒ–æ‰“åŒ…)",
    "å¯åŠ¨æ—¶é—´": "<1.5ç§’ (çº¯å‡€ç¯å¢ƒå¿«é€Ÿå¯åŠ¨)",
    "ä¾èµ–çº¯å‡€æ€§": "ä»…åŒ…å«requirements.txtä¸­çš„å¿…éœ€åŒ…",
    "å…¼å®¹æ€§": "Windows 7/10/11 - é›¶Pythonç¯å¢ƒä¾èµ–",
    "å¯é‡ç°æ€§": "100%å¯é‡ç°çš„æ„å»ºæµç¨‹",
    "è´¨é‡ä¿éšœ": "è™šæ‹Ÿç¯å¢ƒå¼ºåˆ¶éªŒè¯+è‡ªåŠ¨åŒ–æµ‹è¯•"
}

# è™šæ‹Ÿç¯å¢ƒæ„å»ºæµç¨‹æ ‡å‡†
venv_build_standards = {
    "ç¯å¢ƒåˆ›å»º": "python -m venv build_env --clear",
    "ä¾èµ–å®‰è£…": "pip install --no-cache-dir -r requirements.txt",
    "ç¯å¢ƒéªŒè¯": "éªŒè¯åŒ…åˆ—è¡¨å’Œç‰ˆæœ¬å®Œå…¨åŒ¹é…",
    "æ„å»ºæ‰§è¡Œ": "åœ¨è™šæ‹Ÿç¯å¢ƒä¸­è¿è¡ŒPyInstaller",
    "è´¨é‡æ£€æŸ¥": "éªŒè¯exeæ–‡ä»¶å¤§å°å’Œä¾èµ–å®Œæ•´æ€§"
}
```

## ğŸ“‹ è¯¦ç»†å®æ–½æ–¹æ¡ˆ

### Phase 1: è™šæ‹Ÿç¯å¢ƒPyInstalleré…ç½®

#### 1.1 è™šæ‹Ÿç¯å¢ƒè®¾ç½®ï¼ˆå…³é”®æ­¥éª¤ï¼‰
```bash
# åˆ›å»ºå’Œé…ç½®è™šæ‹Ÿç¯å¢ƒ
python -m venv venv_wechat_tool
venv_wechat_tool\Scripts\activate

# åœ¨è™šæ‹Ÿç¯å¢ƒä¸­å®‰è£…ä¾èµ–
pip install -r requirements.txt
pip install pyinstaller

# éªŒè¯è™šæ‹Ÿç¯å¢ƒçŠ¶æ€
where python  # åº”è¯¥æŒ‡å‘è™šæ‹Ÿç¯å¢ƒ
where pyinstaller  # åº”è¯¥æŒ‡å‘è™šæ‹Ÿç¯å¢ƒ
pip list  # æŸ¥çœ‹è™šæ‹Ÿç¯å¢ƒä¸­çš„åŒ…
```

#### 1.2 è™šæ‹Ÿç¯å¢ƒæ‰“åŒ…é…ç½®
```python
# build_from_venv.py - ç¡®ä¿ä»è™šæ‹Ÿç¯å¢ƒæ‰“åŒ…
import sys
import os
import PyInstaller.__main__

def verify_virtual_env():
    """éªŒè¯å½“å‰è¿è¡Œåœ¨è™šæ‹Ÿç¯å¢ƒä¸­"""
    if hasattr(sys, 'real_prefix') or (hasattr(sys, 'base_prefix') and sys.base_prefix != sys.prefix):
        print(f"âœ“ è¿è¡Œåœ¨è™šæ‹Ÿç¯å¢ƒ: {sys.prefix}")
        return True
    else:
        print("âœ— è­¦å‘Šï¼šæœªåœ¨è™šæ‹Ÿç¯å¢ƒä¸­è¿è¡Œï¼")
        print(f"å½“å‰Pythonè·¯å¾„: {sys.executable}")
        return False

def build_application():
    if not verify_virtual_env():
        print("è¯·å…ˆæ¿€æ´»è™šæ‹Ÿç¯å¢ƒå†è¿è¡Œæ‰“åŒ…")
        return False
        
    # æ˜¾ç¤ºæ‰“åŒ…ç¯å¢ƒä¿¡æ¯
    print(f"Pythonç‰ˆæœ¬: {sys.version}")
    print(f"Pythonè·¯å¾„: {sys.executable}")
    print(f"å·¥ä½œç›®å½•: {os.getcwd()}")
    
    PyInstaller.__main__.run([
        '--name=WeChatOneDriveTool',
        '--onefile',                    # å•æ–‡ä»¶æ‰“åŒ…
        '--windowed',                   # æ— æ§åˆ¶å°çª—å£
        '--icon=gui/resources/icons/app.ico',  # v4.0ä¸“ä¸šå›¾æ ‡
        
        # æ•°æ®æ–‡ä»¶åŒ…å«
        '--add-data=configs;configs',
        '--add-data=gui/resources/icons;gui/resources/icons',
        
        # æ’é™¤ç³»ç»Ÿæ¨¡å—ï¼ˆä¿æŒè™šæ‹Ÿç¯å¢ƒçº¯å‡€ï¼‰
        '--exclude-module=test',
        '--exclude-module=unittest', 
        '--exclude-module=pdb',
        '--exclude-module=doctest',
        '--exclude-module=distutils',
        
        # ä¼˜åŒ–é€‰é¡¹
        '--optimize=2',                 # Pythonå­—èŠ‚ç ä¼˜åŒ–
        '--strip',                      # å»é™¤è°ƒè¯•ç¬¦å·
        '--noupx',                      # ä¸ä½¿ç”¨UPXå‹ç¼©
        
        # æ¸…ç†é€‰é¡¹
        '--clean',                      # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        '--noconfirm',                  # ä¸ç¡®è®¤è¦†ç›–
        
        # ä¸»ç¨‹åºå…¥å£
        'gui_app.py'
    ])
    
    return True

if __name__ == '__main__':
    build_application()
```

#### 1.3 è™šæ‹Ÿç¯å¢ƒspecæ–‡ä»¶é…ç½®ï¼ˆv4.0æ›´æ–°ç‰ˆï¼‰
```python
# WeChatOneDriveTool.spec - v4.0è™šæ‹Ÿç¯å¢ƒä¸“ç”¨é…ç½®
# -*- mode: python ; coding: utf-8 -*-
import sys
import os

# éªŒè¯è™šæ‹Ÿç¯å¢ƒ
if not (hasattr(sys, 'real_prefix') or (hasattr(sys, 'base_prefix') and sys.base_prefix != sys.prefix)):
    raise Exception("å¿…é¡»åœ¨è™šæ‹Ÿç¯å¢ƒä¸­è¿è¡ŒPyInstaller")

block_cipher = None

# åˆ†ææ¨¡å—ä¾èµ–ï¼ˆä»…é™è™šæ‹Ÿç¯å¢ƒï¼‰
a = Analysis(
    ['gui_app.py'],
    pathex=[os.getcwd()],  # ä½¿ç”¨å½“å‰å·¥ä½œç›®å½•
    binaries=[],
    datas=[
        ('configs', 'configs'),
        ('gui/resources/icons', 'gui/resources/icons'),
        ('data', 'data')  # v4.0æ–°å¢ï¼šè¿è¡Œæ—¶çŠ¶æ€æ–‡ä»¶
    ],
    hiddenimports=[
        'ttkbootstrap',         # v4.0ç°ä»£åŒ–GUIæ¡†æ¶
        'psutil',
        'schedule',
        'pystray',             # ç³»ç»Ÿæ‰˜ç›˜æ”¯æŒ
        'PIL',                 # å›¾åƒå¤„ç†
    ],
    hookspath=[],
    hooksconfig={},
    runtime_hooks=[],
    excludes=[
        'tkinter',
        'test',
        'unittest',
        'pdb',
        'doctest',
        'sqlite3',          # å¦‚æœä¸ä½¿ç”¨æ•°æ®åº“
        'xml',              # å¦‚æœä¸ä½¿ç”¨XML
        'email',            # å¦‚æœä¸ä½¿ç”¨é‚®ä»¶
        'html',             # å¦‚æœä¸ä½¿ç”¨HTMLè§£æ
    ],
    win_no_prefer_redirects=False,
    win_private_assemblies=False,
    cipher=block_cipher,
    noarchive=False,
)

# ä¼˜åŒ–äºŒè¿›åˆ¶æ–‡ä»¶
pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)

# ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶
exe = EXE(
    pyz,
    a.scripts,
    a.binaries,
    a.zipfiles,
    a.datas,
    [],
    name='WeChatOneDriveTool',
    debug=False,
    bootloader_ignore_signals=False,
    strip=True,
    upx=False,                      # UPXå‹ç¼©(å¯é€‰)
    upx_exclude=[],
    runtime_tmpdir=None,
    console=False,                  # æ— æ§åˆ¶å°
    disable_windowed_traceback=False,
    target_arch=None,
    codesign_identity=None,
    entitlements_file=None,
    icon='gui/resources/icons/app.ico',  # v4.0ä¸“ä¸šå¤šåˆ†è¾¨ç‡å›¾æ ‡
    
    # ç‰ˆæœ¬ä¿¡æ¯
    version='version_info.txt'
)
```

#### 1.4 ç‰ˆæœ¬ä¿¡æ¯é…ç½®ï¼ˆv4.0æ›´æ–°ç‰ˆï¼‰
```python
# version_info.txt - v4.0ç‰ˆæœ¬ä¿¡æ¯
VSVersionInfo(
  ffi=FixedFileInfo(
    filevers=(4, 0, 0, 0),
    prodvers=(4, 0, 0, 0),
    mask=0x3f,
    flags=0x0,
    OS=0x40004,
    fileType=0x1,
    subtype=0x0,
    date=(0, 0)
  ),
  kids=[
    StringFileInfo([
      StringTable(
        u'080404B0',
        [StringStruct(u'CompanyName', u'WeChatOneDrive Solutions'),
         StringStruct(u'FileDescription', u'å¾®ä¿¡OneDriveå†²çªè§£å†³å·¥å…·'),
         StringStruct(u'FileVersion', u'4.0.0.0'),
         StringStruct(u'InternalName', u'WeChatOneDriveTool'),
         StringStruct(u'LegalCopyright', u'Copyright Â© 2025'),
         StringStruct(u'OriginalFilename', u'WeChatOneDriveTool.exe'),
         StringStruct(u'ProductName', u'å¾®ä¿¡OneDriveå†²çªè§£å†³å·¥å…·'),
         StringStruct(u'ProductVersion', u'4.0.0.0')])
    ]),
    VarFileInfo([VarStruct(u'Translation', [2052, 1200])])
  ]
)
```

### Phase 2: å›¾æ ‡ç³»ç»Ÿå®Œæ•´å®ç°ï¼ˆv4.0æ–°å¢ï¼‰

#### 2.1 å›¾æ ‡èµ„æºå‡†å¤‡
```python
# icon_preparation.py - v4.0å›¾æ ‡ç³»ç»Ÿå‡†å¤‡è„šæœ¬
import os
from PIL import Image

def prepare_packaging_icons():
    """ä¸ºæ‰“åŒ…å‡†å¤‡å®Œæ•´çš„å›¾æ ‡èµ„æº"""
    
    # éªŒè¯å›¾æ ‡æ–‡ä»¶å­˜åœ¨
    required_icons = [
        'gui/resources/icons/app.ico',      # å¤šåˆ†è¾¨ç‡ä¸»å›¾æ ‡
        'gui/resources/icons/main.png',     # 30x30 GUIå›¾æ ‡
        'gui/resources/downloads/main_transp_bg.png'  # é€æ˜èƒŒæ™¯åŸå›¾
    ]
    
    missing_icons = []
    for icon_path in required_icons:
        if not os.path.exists(icon_path):
            missing_icons.append(icon_path)
    
    if missing_icons:
        print("é”™è¯¯ï¼šç¼ºå°‘å›¾æ ‡æ–‡ä»¶ï¼š")
        for icon in missing_icons:
            print(f"  - {icon}")
        return False
    
    # éªŒè¯ICOæ–‡ä»¶åŒ…å«å¤šåˆ†è¾¨ç‡
    try:
        with Image.open('gui/resources/icons/app.ico') as ico:
            print(f"ICOæ–‡ä»¶éªŒè¯: {ico.format}, å°ºå¯¸: {ico.size}")
            # æ£€æŸ¥ICOæ–‡ä»¶ä¸­çš„å¤šåˆ†è¾¨ç‡å›¾åƒ
            sizes = []
            try:
                i = 0
                while True:
                    ico.seek(i)
                    sizes.append(ico.size)
                    i += 1
            except EOFError:
                pass
            
            print(f"ICOåŒ…å«åˆ†è¾¨ç‡: {sizes}")
            if len(sizes) >= 4:  # è‡³å°‘åŒ…å«4ç§åˆ†è¾¨ç‡
                print("âœ“ ICOæ–‡ä»¶æ ¼å¼æ­£ç¡®")
                return True
            else:
                print("âœ— ICOæ–‡ä»¶åˆ†è¾¨ç‡ä¸è¶³ï¼Œå»ºè®®åŒ…å«æ›´å¤šå°ºå¯¸")
                return False
                
    except Exception as e:
        print(f"âœ— ICOæ–‡ä»¶éªŒè¯å¤±è´¥: {e}")
        return False

if __name__ == '__main__':
    prepare_packaging_icons()
```

#### 2.2 é«˜çº§æ‰“åŒ…ä¼˜åŒ–ï¼ˆå›¾æ ‡ç›¸å…³ï¼‰

```python
# advanced_packaging_optimizer.py
import ast
import importlib
from pathlib import Path

class PackagingOptimizer:
    def __init__(self):
        self.core_modules = set()
        self.optional_modules = set()
        self.unused_modules = set()
        
    def analyze_imports(self, source_dir):
        """åˆ†æå®é™…ä½¿ç”¨çš„æ¨¡å—"""
        for py_file in Path(source_dir).rglob('*.py'):
            with open(py_file, 'r', encoding='utf-8') as f:
                tree = ast.parse(f.read())
                
            for node in ast.walk(tree):
                if isinstance(node, ast.Import):
                    for alias in node.names:
                        self.core_modules.add(alias.name.split('.')[0])
                elif isinstance(node, ast.ImportFrom):
                    if node.module:
                        self.core_modules.add(node.module.split('.')[0])
                        
    def generate_excludes(self):
        """ç”Ÿæˆæ’é™¤æ¨¡å—åˆ—è¡¨"""
        all_stdlib_modules = set(sys.stdlib_module_names) if hasattr(sys, 'stdlib_module_names') else set()
        unused_stdlib = all_stdlib_modules - self.core_modules
        
        # å¸¸è§çš„å¯å®‰å…¨æ’é™¤çš„æ ‡å‡†åº“æ¨¡å—
        safe_excludes = {
            'tkinter', 'test', 'unittest', 'pdb', 'doctest',
            'sqlite3', 'xml', 'email', 'html', 'http',
            'urllib', 'json', 'csv', 'pickle', 'base64'
        }
        
        return list(unused_stdlib & safe_excludes)

    def optimize_icon_resources(self, icons_dir):
        """ä¼˜åŒ–å›¾æ ‡èµ„æºæ–‡ä»¶å¤§å°"""
        optimized_count = 0
        
        for icon_file in Path(icons_dir).rglob('*.png'):
            original_size = icon_file.stat().st_size
            
            try:
                # ä½¿ç”¨PILä¼˜åŒ–PNGæ–‡ä»¶
                with Image.open(icon_file) as img:
                    # å¦‚æœæ˜¯RGBAæ¨¡å¼ï¼Œæ£€æŸ¥æ˜¯å¦çœŸçš„éœ€è¦é€æ˜é€šé“
                    if img.mode == 'RGBA':
                        # æ£€æŸ¥æ˜¯å¦æœ‰é€æ˜åƒç´ 
                        extrema = img.getextrema()
                        if len(extrema) == 4 and extrema[3] == (255, 255):
                            # æ²¡æœ‰é€æ˜åƒç´ ï¼Œè½¬æ¢ä¸ºRGB
                            img = img.convert('RGB')
                            icon_file_rgb = icon_file.with_suffix('.rgb.png')
                            img.save(icon_file_rgb, 'PNG', optimize=True)
                            
                            # æ¯”è¾ƒæ–‡ä»¶å¤§å°
                            new_size = icon_file_rgb.stat().st_size
                            if new_size < original_size:
                                icon_file_rgb.replace(icon_file)
                                optimized_count += 1
                                print(f"ä¼˜åŒ–: {icon_file.name} ({original_size} -> {new_size} bytes)")
                            else:
                                icon_file_rgb.unlink()
                    
                    # æ— è®ºå¦‚ä½•éƒ½å°è¯•optimize=Trueä¿å­˜
                    img.save(icon_file, 'PNG', optimize=True)
                    
            except Exception as e:
                print(f"ä¼˜åŒ–å›¾æ ‡å¤±è´¥ {icon_file}: {e}")
        
        return optimized_count
```

### Phase 3: å¼€æœºè‡ªå¯åŠ¨å’Œæ‰˜ç›˜å¯åŠ¨å®ç°

#### 3.1 å¼€æœºè‡ªå¯åŠ¨åŠŸèƒ½å®ç°

```python
# startup_manager.py - v4.0å¼€æœºè‡ªå¯åŠ¨ç®¡ç†
import os
import sys
import winreg
from pathlib import Path

class StartupManager:
    def __init__(self):
        self.app_name = "WeChatOneDriveTool"
        self.registry_key = r"SOFTWARE\Microsoft\Windows\CurrentVersion\Run"
        
    def get_exe_path(self):
        """è·å–å½“å‰å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„"""
        if getattr(sys, 'frozen', False):
            # PyInstalleræ‰“åŒ…åçš„exeè·¯å¾„
            return sys.executable
        else:
            # å¼€å‘ç¯å¢ƒï¼Œè¿”å›è„šæœ¬è·¯å¾„
            return os.path.abspath(__file__)
    
    def is_startup_enabled(self):
        """æ£€æŸ¥æ˜¯å¦å·²è®¾ç½®å¼€æœºè‡ªå¯"""
        try:
            with winreg.OpenKey(winreg.HKEY_CURRENT_USER, self.registry_key) as key:
                value, _ = winreg.QueryValueEx(key, self.app_name)
                return os.path.exists(value.split(' --')[0])  # å»é™¤å¯åŠ¨å‚æ•°æ£€æŸ¥æ–‡ä»¶
        except (FileNotFoundError, OSError):
            return False
    
    def enable_startup(self, minimized=True):
        """å¯ç”¨å¼€æœºè‡ªå¯åŠ¨"""
        try:
            exe_path = self.get_exe_path()
            startup_command = f'"{exe_path}"'
            
            # å¦‚æœè®¾ç½®ä¸ºæœ€å°åŒ–å¯åŠ¨ï¼Œæ·»åŠ å‚æ•°
            if minimized:
                startup_command += " --start-minimized"
            
            with winreg.CreateKey(winreg.HKEY_CURRENT_USER, self.registry_key) as key:
                winreg.SetValueEx(key, self.app_name, 0, winreg.REG_SZ, startup_command)
            
            return True, "å¼€æœºè‡ªå¯åŠ¨å·²å¯ç”¨"
        except Exception as e:
            return False, f"å¯ç”¨å¼€æœºè‡ªå¯åŠ¨å¤±è´¥: {e}"
    
    def disable_startup(self):
        """ç¦ç”¨å¼€æœºè‡ªå¯åŠ¨"""
        try:
            with winreg.OpenKey(winreg.HKEY_CURRENT_USER, self.registry_key, 0, winreg.KEY_WRITE) as key:
                winreg.DeleteValue(key, self.app_name)
            return True, "å¼€æœºè‡ªå¯åŠ¨å·²ç¦ç”¨"
        except FileNotFoundError:
            return True, "å¼€æœºè‡ªå¯åŠ¨æœªè®¾ç½®"
        except Exception as e:
            return False, f"ç¦ç”¨å¼€æœºè‡ªå¯åŠ¨å¤±è´¥: {e}"
    
    def get_startup_command(self):
        """è·å–å½“å‰çš„å¯åŠ¨å‘½ä»¤"""
        try:
            with winreg.OpenKey(winreg.HKEY_CURRENT_USER, self.registry_key) as key:
                value, _ = winreg.QueryValueEx(key, self.app_name)
                return value
        except (FileNotFoundError, OSError):
            return None
```

#### 3.2 æœ€å°åŒ–æ‰˜ç›˜å¯åŠ¨åŠŸèƒ½å®ç°

```python
# minimized_startup.py - v4.0æœ€å°åŒ–å¯åŠ¨ç®¡ç†
import argparse
import sys
from gui.main_window import MainWindow
from gui.system_tray import SystemTray, TRAY_AVAILABLE

class MinimizedStartupManager:
    def __init__(self):
        self.main_window = None
        self.system_tray = None
        self.start_minimized = False
    
    def parse_startup_args(self):
        """è§£æå¯åŠ¨å‚æ•°"""
        parser = argparse.ArgumentParser(description='å¾®ä¿¡OneDriveå†²çªè§£å†³å·¥å…·')
        parser.add_argument('--start-minimized', action='store_true', 
                          help='å¯åŠ¨æ—¶æœ€å°åŒ–åˆ°ç³»ç»Ÿæ‰˜ç›˜')
        parser.add_argument('--hidden', action='store_true',
                          help='å®Œå…¨éšè—å¯åŠ¨ï¼ˆä»…æ‰˜ç›˜ï¼‰')
        
        args = parser.parse_args()
        self.start_minimized = args.start_minimized or args.hidden
        return args
    
    def initialize_application(self):
        """åˆå§‹åŒ–åº”ç”¨ç¨‹åº"""
        # åˆ›å»ºä¸»çª—å£
        self.main_window = MainWindow()
        
        # å¦‚æœæ”¯æŒæ‰˜ç›˜ä¸”è®¾ç½®äº†æœ€å°åŒ–å¯åŠ¨
        if TRAY_AVAILABLE and self.start_minimized:
            # åˆå§‹åŒ–ç³»ç»Ÿæ‰˜ç›˜
            self.system_tray = SystemTray(self.main_window)
            
            # å¯åŠ¨æ‰˜ç›˜
            if self.system_tray.start():
                # æ‰˜ç›˜å¯åŠ¨æˆåŠŸï¼Œéšè—ä¸»çª—å£
                self.main_window.withdraw()  # éšè—çª—å£
                self.main_window.log_message("ç¨‹åºå·²æœ€å°åŒ–åˆ°ç³»ç»Ÿæ‰˜ç›˜å¯åŠ¨", "INFO")
                return True
            else:
                # æ‰˜ç›˜å¯åŠ¨å¤±è´¥ï¼Œæ˜¾ç¤ºä¸»çª—å£
                self.main_window.log_message("ç³»ç»Ÿæ‰˜ç›˜å¯åŠ¨å¤±è´¥ï¼Œæ˜¾ç¤ºä¸»çª—å£", "WARNING")
                self.show_main_window()
                return False
        else:
            # æ­£å¸¸æ˜¾ç¤ºä¸»çª—å£
            self.show_main_window()
            return True
    
    def show_main_window(self):
        """æ˜¾ç¤ºä¸»çª—å£"""
        if self.main_window:
            self.main_window.deiconify()
            self.main_window.lift()
            self.main_window.focus_force()
    
    def start_application(self):
        """å¯åŠ¨åº”ç”¨ç¨‹åº"""
        args = self.parse_startup_args()
        
        if self.initialize_application():
            # è¿è¡Œä¸»å¾ªç¯
            if hasattr(self.main_window, 'root'):
                self.main_window.root.mainloop()
            else:
                self.main_window.mainloop()
        else:
            sys.exit(1)

# åœ¨gui_app.pyä¸­é›†æˆæœ€å°åŒ–å¯åŠ¨
def main():
    """ä¸»å‡½æ•° - æ”¯æŒæœ€å°åŒ–å¯åŠ¨"""
    startup_manager = MinimizedStartupManager()
    startup_manager.start_application()

if __name__ == "__main__":
    main()
```

#### 3.3 é…ç½®é¢æ¿é›†æˆå®ç°

```python
# åœ¨gui/config_panel.pyä¸­æ·»åŠ å¼€æœºè‡ªå¯åŠŸèƒ½
from core.startup_manager import StartupManager

class ConfigPanel:
    def __init__(self, parent):
        # ... ç°æœ‰ä»£ç  ...
        self.startup_manager = StartupManager()
        
    def create_startup_settings(self, parent):
        """åˆ›å»ºå¯åŠ¨è®¾ç½®åŒºåŸŸï¼ˆæ›´æ–°ç‰ˆï¼‰"""
        # ... ç°æœ‰UIä»£ç  ...
        
        # å¼€æœºè‡ªå¯åŠ¨è®¾ç½®ï¼ˆç°åœ¨å¯ä»¥çœŸæ­£å·¥ä½œï¼‰
        self.vars['auto_start'] = tk.BooleanVar()
        auto_start_check = ttk.Checkbutton(
            content, 
            text="å¼€æœºè‡ªåŠ¨å¯åŠ¨ç›‘æ§æœåŠ¡", 
            variable=self.vars['auto_start'],
            command=self.on_auto_start_change
        )
        auto_start_check.pack(anchor=W, pady=5)
        
        # æœ€å°åŒ–æ‰˜ç›˜å¯åŠ¨ï¼ˆç°åœ¨å¯ä»¥çœŸæ­£å·¥ä½œï¼‰
        self.vars['minimize_to_tray'] = tk.BooleanVar()
        minimize_check = ttk.Checkbutton(
            content, 
            text="ç¨‹åºå¯åŠ¨æ—¶è‡ªåŠ¨æœ€å°åŒ–åˆ°ç³»ç»Ÿæ‰˜ç›˜", 
            variable=self.vars['minimize_to_tray'],
            command=self.on_config_change
        )
        minimize_check.pack(anchor=W, pady=5)
        
        # æ˜¾ç¤ºå½“å‰å¼€æœºè‡ªå¯çŠ¶æ€
        status_label = ttk.Label(content, text="")
        status_label.pack(anchor=W, pady=2)
        self.update_startup_status_label(status_label)
        
    def on_auto_start_change(self):
        """å¤„ç†å¼€æœºè‡ªå¯åŠ¨è®¾ç½®å˜åŒ–"""
        try:
            if self.vars['auto_start'].get():
                # å¯ç”¨å¼€æœºè‡ªå¯ï¼Œå¹¶æ£€æŸ¥æ˜¯å¦éœ€è¦æœ€å°åŒ–
                minimized = self.vars['minimize_to_tray'].get()
                success, message = self.startup_manager.enable_startup(minimized)
            else:
                # ç¦ç”¨å¼€æœºè‡ªå¯
                success, message = self.startup_manager.disable_startup()
            
            if success:
                self.show_message("æˆåŠŸ", message, "info")
            else:
                self.show_message("é”™è¯¯", message, "error")
                # æ¢å¤åŸå§‹çŠ¶æ€
                self.vars['auto_start'].set(self.startup_manager.is_startup_enabled())
                
        except Exception as e:
            self.show_message("é”™è¯¯", f"è®¾ç½®å¼€æœºè‡ªå¯åŠ¨æ—¶å‡ºé”™: {e}", "error")
            
        # æ›´æ–°é…ç½®å¹¶ä¿å­˜
        self.on_config_change()
        
    def load_config_data(self):
        """åŠ è½½é…ç½®æ•°æ®ï¼ˆæ›´æ–°ç‰ˆï¼‰"""
        try:
            # ... ç°æœ‰ä»£ç  ...
            
            # åŠ è½½å¼€æœºè‡ªå¯åŠ¨å®é™…çŠ¶æ€ï¼ˆè€Œä¸æ˜¯é…ç½®æ–‡ä»¶ä¸­çš„å€¼ï¼‰
            actual_startup_enabled = self.startup_manager.is_startup_enabled()
            self.vars['auto_start'].set(actual_startup_enabled)
            
            # å¦‚æœé…ç½®æ–‡ä»¶å’Œå®é™…çŠ¶æ€ä¸ä¸€è‡´ï¼Œæ›´æ–°é…ç½®æ–‡ä»¶
            config_startup = startup_config.get('auto_start_service', False)
            if config_startup != actual_startup_enabled:
                self.config_manager.set('startup.auto_start_service', actual_startup_enabled)
                self.config_manager.save()
            
        except Exception as e:
            self.show_message("é”™è¯¯", f"åŠ è½½é…ç½®å¤±è´¥: {str(e)}", "error")
            
    def update_startup_status_label(self, label):
        """æ›´æ–°å¼€æœºè‡ªå¯åŠ¨çŠ¶æ€æ˜¾ç¤º"""
        try:
            if self.startup_manager.is_startup_enabled():
                command = self.startup_manager.get_startup_command()
                if "--start-minimized" in command:
                    status = "âœ“ å·²å¯ç”¨ï¼ˆæœ€å°åŒ–å¯åŠ¨ï¼‰"
                else:
                    status = "âœ“ å·²å¯ç”¨ï¼ˆæ­£å¸¸å¯åŠ¨ï¼‰"
                label.configure(text=status, foreground="green")
            else:
                label.configure(text="âœ— æœªå¯ç”¨", foreground="gray")
        except Exception as e:
            label.configure(text=f"çŠ¶æ€æ£€æŸ¥å¤±è´¥: {e}", foreground="red")
```

### Phase 4: å®‰è£…ç¨‹åºå¼€å‘(NSIS) - v4.0å›¾æ ‡å¢å¼ºç‰ˆ

#### 3.1 ç°ä»£åŒ–å®‰è£…ç¨‹åºç•Œé¢ï¼ˆv4.0ç‰ˆæœ¬ï¼‰
```nsis
; WeChatOneDriveTool_v4_Installer.nsi
; v4.0ç‰ˆæœ¬å®‰è£…ç¨‹åº - å›¾æ ‡ç³»ç»Ÿå®Œæ•´æ”¯æŒ

!include "MUI2.nsh"
!include "WinVer.nsh"

; v4.0å®‰è£…ç¨‹åºåŸºæœ¬ä¿¡æ¯
Name "å¾®ä¿¡OneDriveå†²çªè§£å†³å·¥å…· v4.0"
OutFile "WeChatOneDriveTool_v4.0_Setup.exe"
InstallDir "$PROGRAMFILES\WeChatOneDriveTool"
InstallDirRegKey HKCU "Software\WeChatOneDriveTool" ""
RequestExecutionLevel admin

; ç°ä»£UIé…ç½® - ä½¿ç”¨v4.0ä¸“ä¸šå›¾æ ‡
!define MUI_ABORTWARNING
!define MUI_ICON "gui\resources\icons\app.ico"        ; å®‰è£…ç¨‹åºå›¾æ ‡
!define MUI_UNICON "gui\resources\icons\app.ico"      ; å¸è½½ç¨‹åºå›¾æ ‡

; æ¬¢è¿é¡µé¢
!define MUI_WELCOMEPAGE_TITLE "æ¬¢è¿å®‰è£…å¾®ä¿¡OneDriveå†²çªè§£å†³å·¥å…· v4.0"
!define MUI_WELCOMEPAGE_TEXT "è¿™ä¸ªå‘å¯¼å°†å¼•å¯¼æ‚¨å®Œæˆå¾®ä¿¡OneDriveå†²çªè§£å†³å·¥å…· v4.0 çš„å®‰è£…ã€‚$\r$\n$\r$\næœ¬ç‰ˆæœ¬ç‰¹æ€§ï¼š$\r$\nâ€¢ ä¸“ä¸šçº§åº”ç”¨ç¨‹åºå›¾æ ‡$\r$\nâ€¢ é€æ˜èƒŒæ™¯è®¾è®¡$\r$\nâ€¢ å¤šåˆ†è¾¨ç‡æ”¯æŒ$\r$\nâ€¢ ç°ä»£åŒ–ç”¨æˆ·ç•Œé¢$\r$\n$\r$\n$_CLICK"

; è®¸å¯åè®®é¡µé¢
!define MUI_LICENSEPAGE_TEXT_TOP "è¯·ä»”ç»†é˜…è¯»ä»¥ä¸‹è®¸å¯åè®®ã€‚"
!define MUI_LICENSEPAGE_TEXT_BOTTOM "å¦‚æœæ‚¨æ¥å—åè®®ä¸­çš„æ¡æ¬¾ï¼Œè¯·ç‚¹å‡»"åŒæ„"ç»§ç»­å®‰è£…ã€‚"

; å®‰è£…ç›®å½•é¡µé¢
!define MUI_DIRECTORYPAGE_TEXT_TOP "å®‰è£…ç¨‹åºå°†åœ¨ä»¥ä¸‹æ–‡ä»¶å¤¹ä¸­å®‰è£…å¾®ä¿¡OneDriveå†²çªè§£å†³å·¥å…· v4.0ã€‚$\r$\n$\r$\nè¦å®‰è£…åˆ°å…¶ä»–æ–‡ä»¶å¤¹ï¼Œè¯·ç‚¹å‡»"æµè§ˆ"å¹¶é€‰æ‹©å…¶ä»–æ–‡ä»¶å¤¹ã€‚"

; ç»„ä»¶é€‰æ‹©é¡µé¢
!define MUI_COMPONENTSPAGE_TEXT_TOP "é€‰æ‹©æ‚¨æƒ³è¦å®‰è£…çš„ç»„ä»¶ï¼š"

; å®Œæˆé¡µé¢
!define MUI_FINISHPAGE_TITLE "å®‰è£…å®Œæˆ"
!define MUI_FINISHPAGE_TEXT "å¾®ä¿¡OneDriveå†²çªè§£å†³å·¥å…· v4.0 å·²æˆåŠŸå®‰è£…åˆ°æ‚¨çš„è®¡ç®—æœºã€‚$\r$\n$\r$\næ–°ç‰ˆæœ¬ç‰¹è‰²ï¼š$\r$\nâ€¢ ä»»åŠ¡æ æ˜¾ç¤ºä¸“ä¸šåº”ç”¨å›¾æ ‡$\r$\nâ€¢ ç³»ç»Ÿæ‰˜ç›˜ç¾è§‚é€æ˜è®¾è®¡$\r$\nâ€¢ å®Œæ•´çš„å›¾æ ‡ç³»ç»Ÿæ”¯æŒ$\r$\n$\r$\nç‚¹å‡»"å®Œæˆ"é€€å‡ºå®‰è£…å‘å¯¼ã€‚"
!define MUI_FINISHPAGE_RUN "$INSTDIR\WeChatOneDriveTool.exe"
!define MUI_FINISHPAGE_RUN_TEXT "ç«‹å³è¿è¡Œå¾®ä¿¡OneDriveå†²çªè§£å†³å·¥å…· v4.0"

; é¡µé¢é¡ºåº
!insertmacro MUI_PAGE_WELCOME
!insertmacro MUI_PAGE_LICENSE "LICENSE.txt"
!insertmacro MUI_PAGE_COMPONENTS
!insertmacro MUI_PAGE_DIRECTORY
!insertmacro MUI_PAGE_INSTFILES
!insertmacro MUI_PAGE_FINISH

; å¸è½½é¡µé¢
!insertmacro MUI_UNPAGE_CONFIRM
!insertmacro MUI_UNPAGE_INSTFILES

; è¯­è¨€
!insertmacro MUI_LANGUAGE "SimpChinese"
```

#### 3.2 ç»„ä»¶å®šä¹‰å’Œç³»ç»Ÿæ£€æŸ¥ï¼ˆv4.0ç‰ˆæœ¬ï¼‰
```nsis
; v4.0ç³»ç»Ÿè¦æ±‚æ£€æŸ¥
Function .onInit
  ; æ£€æŸ¥Windowsç‰ˆæœ¬
  ${IfNot} ${AtLeastWin10}
    MessageBox MB_OK|MB_ICONSTOP "æ­¤ç¨‹åºéœ€è¦ Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚"
    Abort
  ${EndIf}
  
  ; æ£€æŸ¥ç®¡ç†å‘˜æƒé™
  UserInfo::GetAccountType
  pop $0
  ${If} $0 != "admin"
    MessageBox MB_OK|MB_ICONSTOP "è¯·ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œå®‰è£…ç¨‹åºã€‚"
    Abort
  ${EndIf}
  
  ; æ£€æŸ¥æ˜¯å¦å·²å®‰è£…æ—§ç‰ˆæœ¬
  ReadRegStr $R0 HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\WeChatOneDriveTool" "UninstallString"
  StrCmp $R0 "" done
  
  MessageBox MB_OKCANCEL|MB_ICONEXCLAMATION "æ£€æµ‹åˆ°å·²å®‰è£…çš„æ—§ç‰ˆæœ¬ï¼Œæ˜¯å¦è¦å¸è½½åå®‰è£… v4.0ï¼Ÿ" IDOK uninst
  Abort
  
  uninst:
    ExecWait '$R0 _?=$INSTDIR'
    
  done:
FunctionEnd

; v4.0å®‰è£…ç»„ä»¶
Section "ä¸»ç¨‹åº v4.0" SecMain
  SectionIn RO  ; å¿…éœ€ç»„ä»¶
  
  SetOutPath "$INSTDIR"
  File "dist\WeChatOneDriveTool.exe"
  File "LICENSE.txt"
  File "README.txt"
  
  ; åˆ›å»ºå¼€å§‹èœå•å¿«æ·æ–¹å¼ï¼ˆä½¿ç”¨ä¸“ä¸šå›¾æ ‡ï¼‰
  CreateDirectory "$SMPROGRAMS\å¾®ä¿¡OneDriveå·¥å…·"
  CreateShortCut "$SMPROGRAMS\å¾®ä¿¡OneDriveå·¥å…·\å¾®ä¿¡OneDriveå†²çªè§£å†³å·¥å…· v4.0.lnk" "$INSTDIR\WeChatOneDriveTool.exe"
  CreateShortCut "$SMPROGRAMS\å¾®ä¿¡OneDriveå·¥å…·\å¸è½½.lnk" "$INSTDIR\Uninstall.exe"
  
  ; å†™å…¥æ³¨å†Œè¡¨ï¼ˆv4.0ç‰ˆæœ¬ä¿¡æ¯ï¼‰
  WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\WeChatOneDriveTool" "DisplayName" "å¾®ä¿¡OneDriveå†²çªè§£å†³å·¥å…· v4.0"
  WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\WeChatOneDriveTool" "DisplayVersion" "4.0.0"
  WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\WeChatOneDriveTool" "UninstallString" "$INSTDIR\Uninstall.exe"
  WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\WeChatOneDriveTool" "DisplayIcon" "$INSTDIR\WeChatOneDriveTool.exe"
  WriteRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\WeChatOneDriveTool" "NoModify" 1
  WriteRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\WeChatOneDriveTool" "NoRepair" 1
  
  WriteUninstaller "$INSTDIR\Uninstall.exe"
SectionEnd

Section "æ¡Œé¢å¿«æ·æ–¹å¼" SecDesktop
  CreateShortCut "$DESKTOP\å¾®ä¿¡OneDriveå†²çªè§£å†³å·¥å…· v4.0.lnk" "$INSTDIR\WeChatOneDriveTool.exe"
SectionEnd

Section "å¼€æœºè‡ªå¯åŠ¨" SecAutoStart
  ; v4.0ç‰ˆæœ¬ï¼šæ”¯æŒé€‰æ‹©å¯åŠ¨æ–¹å¼
  WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Run" "WeChatOneDriveTool" "$INSTDIR\WeChatOneDriveTool.exe --start-minimized"
  
  ; è®¾ç½®é…ç½®æ–‡ä»¶ä¸­çš„å¼€æœºè‡ªå¯é€‰é¡¹
  WriteINIStr "$INSTDIR\configs\config.json" "startup" "auto_start_service" "true"
  WriteINIStr "$INSTDIR\configs\config.json" "startup" "minimize_to_tray" "true"
SectionEnd

Section "å¼€æœºè‡ªå¯åŠ¨ï¼ˆæ˜¾ç¤ºçª—å£ï¼‰" SecAutoStartVisible
  ; å¼€æœºè‡ªå¯ä½†æ˜¾ç¤ºä¸»çª—å£
  WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Run" "WeChatOneDriveTool" "$INSTDIR\WeChatOneDriveTool.exe"
  
  ; è®¾ç½®é…ç½®æ–‡ä»¶
  WriteINIStr "$INSTDIR\configs\config.json" "startup" "auto_start_service" "true"
  WriteINIStr "$INSTDIR\configs\config.json" "startup" "minimize_to_tray" "false"
SectionEnd
```

## ğŸ“Š æ„å»ºè‡ªåŠ¨åŒ–ç³»ç»Ÿ

### GitHub Actions CI/CDï¼ˆv4.0è™šæ‹Ÿç¯å¢ƒå¼ºåˆ¶ç‰ˆï¼‰
```yaml
# .github/workflows/build-release-v4.yml
name: Build and Release v4.0

on:
  push:
    tags:
      - 'v4.*'
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Create clean virtual environment
      run: |
        python -m venv build_venv --clear
        echo "Virtual environment created successfully"
        
    - name: Activate virtual environment and install dependencies
      run: |
        build_venv\Scripts\activate.bat
        python -m pip install --upgrade pip
        pip install --no-cache-dir -r requirements.txt
        pip install --no-cache-dir pyinstaller
        
    - name: Verify virtual environment and prepare icons
      run: |
        build_venv\Scripts\activate.bat
        python -c "import sys; print('Python executable:', sys.executable)"
        python -c "import sys; print('Virtual env:', hasattr(sys, 'real_prefix') or (hasattr(sys, 'base_prefix') and sys.base_prefix != sys.prefix))"
        python icon_preparation.py  # v4.0å›¾æ ‡éªŒè¯
        pip list
        
    - name: Optimize resources
      run: |
        build_venv\Scripts\activate.bat
        python advanced_packaging_optimizer.py
      
    - name: Build executable in virtual environment
      run: |
        build_venv\Scripts\activate.bat
        python build_from_venv.py
        
    - name: Verify exe file and icon
      run: |
        dir dist
        echo "Verifying exe file properties..."
        # å¯ä»¥æ·»åŠ exeæ–‡ä»¶å±æ€§æ£€æŸ¥
        
    - name: Sign executable (if certificates available)
      run: |
        # signtool.exe sign /f certificate.pfx /p ${{ secrets.CERT_PASSWORD }} dist/WeChatOneDriveTool.exe
        echo "Code signing step (configure with actual certificate)"
        
    - name: Build installer
      run: |
        "C:\Program Files (x86)\NSIS\makensis.exe" installer\WeChatOneDriveTool_v4_Installer.nsi
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: windows-executable-v4
        path: |
          dist/WeChatOneDriveTool.exe
          installer/WeChatOneDriveTool_v4.0_Setup.exe
          
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/v4')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/WeChatOneDriveTool.exe
          installer/WeChatOneDriveTool_v4.0_Setup.exe
        name: "v4.0 ä¸“ä¸šæ‰“åŒ…å‘å¸ƒç‰ˆ"
        body: |
          ## v4.0 - ä¸“ä¸šæ‰“åŒ…å‘å¸ƒç‰ˆ

          ### ğŸ¨ å…¨æ–°å›¾æ ‡ç³»ç»Ÿ
          - âœ… ä¸“ä¸šçº§é€æ˜èƒŒæ™¯åº”ç”¨ç¨‹åºå›¾æ ‡
          - âœ… å¤šåˆ†è¾¨ç‡ICOæ–‡ä»¶æ”¯æŒï¼ˆ16x16 åˆ° 256x256ï¼‰
          - âœ… Windowsä»»åŠ¡æ æ­£ç¡®æ˜¾ç¤ºè‡ªå®šä¹‰å›¾æ ‡
          - âœ… ç³»ç»Ÿæ‰˜ç›˜ç¾è§‚é€æ˜è®¾è®¡

          ### ğŸ“¦ ä¸“ä¸šçº§æ‰“åŒ…
          - âœ… å•æ–‡ä»¶EXEï¼Œæ— éœ€Pythonç¯å¢ƒ
          - âœ… è™šæ‹Ÿç¯å¢ƒçº¯å‡€æ‰“åŒ…ï¼Œæ–‡ä»¶å¤§å°ä¼˜åŒ–
          - âœ… Windows 7/10/11å®Œå…¨å…¼å®¹
          - âœ… ä¸“ä¸šç‰ˆæœ¬ä¿¡æ¯å’Œæ•°å­—ç­¾åå‡†å¤‡

          ### ğŸš€ ç”¨æˆ·ä½“éªŒå‡çº§
          - âœ… åŒå‡»å³ç”¨ï¼Œé›¶æŠ€æœ¯é—¨æ§›
          - âœ… ä¸“ä¸šå®‰è£…ç¨‹åºï¼Œæ ‡å‡†å¸è½½æ”¯æŒ
          - âœ… å¼€æœºè‡ªå¯åŠ¨ï¼Œæ¡Œé¢å¿«æ·æ–¹å¼
          - âœ… å®Œæ•´çš„Windowsåº”ç”¨ç¨‹åºä½“éªŒ
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

## ğŸ¯ v4.0è´¨é‡ä¿è¯è®¡åˆ’

### v4.0æ‰“åŒ…æµ‹è¯•çŸ©é˜µï¼ˆå›¾æ ‡é‡ç‚¹ï¼‰
```python
# v4.0æµ‹è¯•ç¯å¢ƒçŸ©é˜µ
v4_test_matrix = {
    "æ“ä½œç³»ç»Ÿ": [
        "Windows 10 1903 (Build 18362)",
        "Windows 10 21H2 (Build 19044)", 
        "Windows 11 21H2 (Build 22000)",
        "Windows 11 22H2 (Build 22621)"
    ],
    "ç³»ç»Ÿæ¶æ„": ["x64"],
    "Pythonç¯å¢ƒ": ["æ— Pythonç¯å¢ƒ", "Python 3.8", "Python 3.11"],
    "ç”¨æˆ·æƒé™": ["æ™®é€šç”¨æˆ·", "ç®¡ç†å‘˜"],
    "å®‰è£…æ–¹å¼": ["å®Œæ•´å®‰è£…", "è‡ªå®šä¹‰å®‰è£…", "é™é»˜å®‰è£…"],
    "å›¾æ ‡æµ‹è¯•": [
        "ä»»åŠ¡æ å›¾æ ‡æ˜¾ç¤º",
        "ç³»ç»Ÿæ‰˜ç›˜å›¾æ ‡æ˜¾ç¤º", 
        "å¼€å§‹èœå•å›¾æ ‡æ˜¾ç¤º",
        "æ¡Œé¢å¿«æ·æ–¹å¼å›¾æ ‡",
        "exeæ–‡ä»¶å›¾æ ‡æ˜¾ç¤º"
    ]
}

# v4.0æµ‹è¯•ç”¨ä¾‹ï¼ˆå›¾æ ‡é‡ç‚¹ï¼‰
v4_test_cases = [
    "é¦–æ¬¡å®‰è£…æµ‹è¯•",
    "å‡çº§å®‰è£…æµ‹è¯•ï¼ˆä»v3.0åˆ°v4.0ï¼‰", 
    "å¸è½½å®Œæ•´æ€§æµ‹è¯•",
    "æ–‡ä»¶å…³è”æµ‹è¯•",
    "å¼€æœºè‡ªå¯åŠ¨æµ‹è¯•",
    "å¤šç”¨æˆ·ç¯å¢ƒæµ‹è¯•",
    "å›¾æ ‡æ˜¾ç¤ºå®Œæ•´æ€§æµ‹è¯•",
    "é«˜DPIå±å¹•å›¾æ ‡æµ‹è¯•",
    "å¤šæ˜¾ç¤ºå™¨å›¾æ ‡æµ‹è¯•",
    "ä¸»é¢˜åˆ‡æ¢å›¾æ ‡å…¼å®¹æµ‹è¯•"
]
```

### v4.0æ€§èƒ½åŸºå‡†æµ‹è¯•
```python
# v4_performance_benchmark.py
class V4PackagingBenchmark:
    def test_startup_with_icon(self):
        """æµ‹è¯•å¸¦å›¾æ ‡çš„å¯åŠ¨æ—¶é—´"""
        times = []
        for _ in range(10):
            start = time.time()
            process = subprocess.Popen(['WeChatOneDriveTool.exe'])
            # ç­‰å¾…ä¸»çª—å£å’Œå›¾æ ‡å®Œå…¨æ˜¾ç¤º
            self.wait_for_window_and_icon("å¾®ä¿¡OneDriveå†²çªè§£å†³å·¥å…·")
            end = time.time()
            times.append(end - start)
            process.terminate()
            
        return {
            'average': sum(times) / len(times),
            'min': min(times),
            'max': max(times)
        }
        
    def test_icon_display_time(self):
        """æµ‹è¯•å›¾æ ‡æ˜¾ç¤ºæ—¶é—´"""
        start = time.time()
        process = subprocess.Popen(['WeChatOneDriveTool.exe'])
        
        # æ£€æµ‹ä»»åŠ¡æ å›¾æ ‡å‡ºç°
        icon_displayed = self.wait_for_taskbar_icon("WeChatOneDriveTool.exe")
        end = time.time()
        
        process.terminate()
        
        return {
            'icon_display_time': end - start if icon_displayed else None,
            'success': icon_displayed
        }
        
    def verify_icon_resources(self):
        """éªŒè¯æ‰“åŒ…åçš„å›¾æ ‡èµ„æº"""
        import win32api
        import win32gui
        
        exe_path = "dist/WeChatOneDriveTool.exe"
        
        try:
            # è·å–exeæ–‡ä»¶å›¾æ ‡ä¿¡æ¯
            large_icon = win32gui.ExtractIcon(0, exe_path, 0)
            small_icon = win32gui.ExtractIcon(0, exe_path, 1)
            
            return {
                'has_large_icon': large_icon != 0,
                'has_small_icon': small_icon != 0,
                'exe_exists': os.path.exists(exe_path)
            }
        except Exception as e:
            return {'error': str(e), 'exe_exists': os.path.exists(exe_path)}
```

## ğŸ“ˆ v4.0é¢„æœŸæˆæœå’ŒæŒ‡æ ‡

### v4.0åˆ†å‘æ•ˆæœæŒ‡æ ‡ï¼ˆå›¾æ ‡ç³»ç»Ÿå¢å¼ºç‰ˆï¼‰
| æŒ‡æ ‡ | v3.0çŠ¶æ€ | v4.0ç›®æ ‡ | æ”¹å–„å¹…åº¦ |
|------|----------|----------|----------|
| å®‰è£…å¤æ‚åº¦ | éœ€è¦Python+pip | åŒå‡»å®‰è£… | **95%ç®€åŒ–** |
| å®‰è£…æ—¶é—´ | 5-15åˆ†é’Ÿ | <1åˆ†é’Ÿ | **90%+æå‡** |
| æ–‡ä»¶å¤§å° | ~200MB(Python+ä¾èµ–) | <30MB | **85%+å‡å°‘** |
| å¯åŠ¨é€Ÿåº¦ | 3-5ç§’ | <1.5ç§’ | **70%+æå‡** |
| **å›¾æ ‡æ˜¾ç¤º** | **Pythoné»˜è®¤å›¾æ ‡** | **ä¸“ä¸šè‡ªå®šä¹‰å›¾æ ‡** | **ç”¨æˆ·ä½“éªŒè´¨å˜** |
| **è§†è§‰ä¸“ä¸šåº¦** | **å¼€å‘è€…å·¥å…·çº§** | **å•†ä¸šè½¯ä»¶çº§** | **å“ç‰Œä»·å€¼å¤§å¹…æå‡** |
| ç”¨æˆ·é—¨æ§› | éœ€è¦æŠ€æœ¯èƒŒæ™¯ | æ™®é€šç”¨æˆ·å¯ç”¨ | **å¤§å¹…é™ä½** |
| æ›´æ–°ä¾¿åˆ©æ€§ | æ‰‹åŠ¨ä¸‹è½½ | ä¸€é”®æ›´æ–° | **ç”¨æˆ·ä½“éªŒè´¨å˜** |
| æ„å»ºè´¨é‡ | ä¸å¯æ§ | 100%å¯é‡ç° | **è´¨é‡ä¿è¯** |

### v4.0å•†ä¸šåŒ–æŒ‡æ ‡é¢„æœŸ
```python
# v4.0ç”¨æˆ·é‡‡ç”¨ç‡é¢„æœŸæå‡
v4_adoption_improvement = {
    "ç›®æ ‡ç”¨æˆ·æ‰©å¤§": "15å€+ (ä¸“ä¸šå›¾æ ‡é™ä½å¿ƒç†é—¨æ§›)",
    "å®‰è£…æˆåŠŸç‡": "ä»60%æå‡åˆ°98%+ (ä¸“ä¸šå®‰è£…ç¨‹åº)",
    "ç”¨æˆ·ç•™å­˜ç‡": "ä»40%æå‡åˆ°85%+ (ä¸“ä¸šç”¨æˆ·ä½“éªŒ)", 
    "å£ç¢‘ä¼ æ’­": "ä»æŠ€æœ¯åœˆæ‰©å±•åˆ°åŠå…¬ç”¨æˆ·ç¾¤ä½“",
    "å“ç‰Œè®¤çŸ¥": "ä»å¼€å‘è€…å·¥å…·å‡çº§ä¸ºä¸“ä¸šè½¯ä»¶äº§å“",
    "è§†è§‰è¯†åˆ«": "ç”¨æˆ·å¯åœ¨ä»»åŠ¡æ è½»æ¾è¯†åˆ«åº”ç”¨ç¨‹åº"
}

# v4.0å›¾æ ‡ç³»ç»Ÿä»·å€¼
v4_icon_system_value = {
    "ä¸“ä¸šåº¦æå‡": "ä¸å•†ä¸šè½¯ä»¶åŒç­‰çš„è§†è§‰ä¸“ä¸šåº¦",
    "ç”¨æˆ·è¯†åˆ«": "ä»»åŠ¡æ ã€æ‰˜ç›˜ã€æ¡Œé¢ç»Ÿä¸€çš„è§†è§‰è¯†åˆ«",
    "å“ç‰Œå»ºè®¾": "ä¸ºäº§å“å»ºç«‹ç‹¬ç‰¹çš„è§†è§‰å“ç‰Œå½¢è±¡",
    "å¿ƒç†é—¨æ§›": "ä¸“ä¸šå›¾æ ‡é™ä½ç”¨æˆ·çš„ä½¿ç”¨å¿ƒç†é˜»åŠ›",
    "æ¨å¹¿æ•ˆæœ": "ä¸“ä¸šè§†è§‰å½¢è±¡æœ‰åˆ©äºäº§å“æ¨å¹¿ä¼ æ’­"
}
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v4.0 - å›¾æ ‡ç³»ç»Ÿå¢å¼ºç‰ˆ  
**æ›´æ–°æ—¥æœŸ**: 2025-08-10  
**è´Ÿè´£äºº**: æ‰“åŒ…åˆ†å‘å›¢é˜Ÿ  
**çŠ¶æ€**: å®æ–½ä¸­ - å›¾æ ‡ç³»ç»Ÿå·²å®Œæˆï¼Œå‡†å¤‡æ‰“åŒ…å®æ–½  
**å…³é”®ç‰¹æ€§**: ä¸“ä¸šçº§é€æ˜èƒŒæ™¯å›¾æ ‡ç³»ç»Ÿ + å¤šåˆ†è¾¨ç‡ICOæ”¯æŒ